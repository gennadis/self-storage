{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
	<link rel="stylesheet" href="{% static 'css/Style.css' %}">
	<title>Ваш бокс</title>
</head>

<body>
	<header>
		{% include 'includes/navbar.html' %}
	</header>

	<aside>
		{% include 'includes/auth.html' %}
	</aside>
  {% if status == "Не оплачено" %}
    <aside class="modal fade" id="CancelModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable modal-fullscreen">
        <div class="modal-content">
          <div class="modal-header border-0">
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body d-flex justify-content-center align-items-center">
            <form method="get" action="/cancel_lease" class="d-flex flex-column align-items-center" style="max-width: 420px">
              <h1 class="modal-title text-center fw-bold mb-4">Отмена заказа</h1>
              
              <div class="row">
                <div class="col-12 d-flex flex-column align-items-center align-items-lg-start">
                  <h4 id="boxWhAddress" class="modal-title text-center mb-3">Вы уверены, что хотите отменить заказ?</h4>
                </div>
              <input type="hidden" name="lease_id" value="{{ id }}">
              <button type="submit" class="btn border-8 py-3 px-5 mt-5 mb-3 w-100 text-white fs_24 SelfStorage__bg_orange SelfStorage__btn2_orange">Отменить заказ</button>
              <a data-bs-dismiss="modal" class="btn border-8 py-3 px-5 mb-3 w-100 text-white fs_12 SelfStorage__bg_orange SelfStorage__btn2_orange">Вернуться к аренде</a>
            </form>
          </div>
        </div>
      </div>
    </aside>
  {% endif %}

  <aside class="modal fade" id="DeliveryModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header border-0">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body d-flex justify-content-center align-items-center">
                <form id="deliveryForm" method="post" class="d-flex flex-column align-items-center" style="max-width: 420px">
                  {% csrf_token %}
                  <h1 class="modal-title text-center fw-bold mb-3">Бесплатная доставка</h1>
                  <span class="fw-light SelfStorage_grey">Укажите адрес, откуда нам следует забрать Ваши вещи.</span>
                  <span class="fw-light SelfStorage_grey mb-3">Наш менеджер свяжется с Вами для уточнения деталей.</span>
                  <span id="errorPrompt" class="fw-light SelfStorage_orange mb-3 d-none"></span>
                  <input type="text" required name="address"
                      class="form-control  border-8 mb-4 py-2 px-3 border-0 fs_14 SelfStorage__bg_lightgrey"
                      placeholder="Адрес">
                  <input type="hidden" name="lease_id" value="{{ id }}">
                  <button id="submitButton" type="submit" class="btn border-8 py-3 px-5 mt-5 mb-3 w-100 text-white fs_24 SelfStorage__bg_orange SelfStorage__btn2_orange">Заказать</button>
                  <a data-bs-dismiss="modal" class="btn border-8 py-3 px-5 mb-3 w-100 text-white fs_12 SelfStorage__bg_orange SelfStorage__btn2_orange">Вернуться к аренде</a>
                </form>
                <div id="deliveryReply" class="d-none d-flex flex-column align-items-center" style="max-width: 420px">
                  <h1 class="modal-title text-center fw-bold mb-3">Бесплатная доставка</h1>
                  <h1 id="deliveryMessage" class="modal-title text-center fw-bold mb-3"></h1>
                  <a data-bs-dismiss="modal" class="btn border-8 py-3 px-5 mb-3 w-100 text-white fs_12 SelfStorage__bg_orange SelfStorage__btn2_orange">Вернуться к аренде</a>
                </div>
                <script>
                  deliveryForm = document.querySelector("#deliveryForm")
                  submitButton = document.querySelector("#submitButton")
                  errorPrompt = document.querySelector("#errorPrompt")
                  deliveryReply = document.querySelector("#deliveryReply")
                  deliveryMessage = document.querySelector("#deliveryMessage")

                  deliveryForm.addEventListener("submit", (event)=>{
                    event.preventDefault()
                    submitButton.disabled = true
                    fetch("/request_delivery/", {
                      method: 'post',
                      body: new FormData(deliveryForm),
                    }).then(response => response.json())
                    .then(json => {
                      console.log(json)
                      if(json.status == "validation_error"){
                        errorPrompt.textContent = json.message
                        errorPrompt.classList.remove("d-none")
                        submitButton.disabled = false
                      }else if(json.status == "already_exists"){
                        deliveryForm.classList.add("d-none")
                        deliveryMessage.textContent = json.message
                        deliveryReply.classList.remove("d-none")
                      }else{
                        deliveryForm.classList.add("d-none")
                        deliveryMessage.textContent = json.message
                        deliveryReply.classList.remove("d-none")
                      }
                    })
                    .catch(error => console.log("error"))
                  })
                </script>
            </div>
        </div>
    </div>
</aside>

  <main class="container mt-header">
    <div class="card text-bg-warning text-center">
      <div class="card-header">
        Аренда #{{ id }}
        {% if status == "Не оплачено" %}
          <span class="badge bg-warning">{{ status }}</span>
        {% elif status == "Оплачено" %}
          <span class="badge bg-success">{{ status }}</span>
        {% elif status == "Просрочено" %}
          <span class="badge bg-danger">{{ status }}</span>
        {% elif status == "Завершено" %}
          <span class="badge bg-dark">{{ status }}</span>
        {% else %}
          <span class="badge bg-secondary">{{ status }}</span>
        {% endif %}
      </div>
      <div class="card-body text">
        {% if status == "Не оплачено" %}
          <form method="post" action="/pay/">{% csrf_token %}
        {% else %}
          <form>
        {% endif %}
          <h5 class="card-title">Бокс №{{ box_code }}</h5>
          <p class="card-text">Цена в месяц - {{ box_rate }} Р.</p>
          <p class="card-text">Срок аренды - до {{ expires_on }}.</p>
          <p class="card-text">Итого - {{ total_price }}.</p>
          <input type="hidden" name="order_price" value="{{ total_price }}"/>
          <input type="hidden" name="order_description" value="Аренда бокса №{{ box_code }} - {{ total_price }} Р"/>
          <input type="hidden" name="lease_id" value="{{ id }}"/>
          {% if status == "Не оплачено" %}
            <button type="submit" class="btn btn-success">Оплатить</button>
            <a data-bs-toggle="modal" data-bs-target="#CancelModal" class="btn btn-danger">Отменить</a>
            <p class="card-text">Оплатите аренду, чтобы получить доступ к боксу или заказать доставку</p>
            <button type="button" class="btn btn-secondary" disabled>Заказать бесплатную доставку</button>
            <button type="button" class="btn btn-secondary" disabled>Получить QR-код доступа</button>
          {% elif status == "Оплачено" %}
            {% if already_delivered %}
              <button type="button" class="btn btn-secondary" disabled>Доставка исполнена</button>
            {% else %}
              <p class="card-text">Наш курьер приедет к Вам и самостоятельно замерит габариты Ваших вещей</p>
              <a data-bs-toggle="modal" data-bs-target="#DeliveryModal" class="btn btn-success">Заказать бесплатную доставку</a>
            {% endif %}
          {% endif %}
        </form>
      </div>
    </div>

	<footer>
		{% include 'includes/footer.html' %}
	</footer>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
		crossorigin="anonymous"></script>
	<script>
		var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
		var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
			return new bootstrap.Popover(popoverTriggerEl)
		})
	</script>
</body>

</html>